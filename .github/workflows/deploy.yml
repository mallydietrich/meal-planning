name: Deploy site

on:
  push:
    branches:
      - master
      - main
    paths:
      - "assets/**"
      - "_sass/**"
      - "_scripts/**"
      - "**.bib"
      - "**.html"
      - "**.js"
      - "**.liquid"
      - "**/*.md"
      - "**.yml"
      - "Gemfile"
      - "Gemfile.lock"
      - "!.github/workflows/axe.yml"
      - "!.github/workflows/broken-links.yml"
      - "!.github/workflows/deploy-docker-tag.yml"
      - "!.github/workflows/deploy-image.yml"
      - "!.github/workflows/docker-slim.yml"
      - "!.github/workflows/lighthouse-badger.yml"
      - "!.github/workflows/prettier.yml"
      - "!lighthouse_results/**"
      - "!CONTRIBUTING.md"
      - "!CUSTOMIZE.md"
      - "!FAQ.md"
      - "!INSTALL.md"
      - "!README.md"
  pull_request:
    branches:
      - master
      - main
    paths:
      - "assets/**"
      - "_sass/**"
      - "_scripts/**"
      - "**.bib"
      - "**.html"
      - "**.js"
      - "**.liquid"
      - "**/*.md"
      - "**.yml"
      - "Gemfile"
      - "Gemfile.lock"
      - "!.github/workflows/axe.yml"
      - "!.github/workflows/broken-links.yml"
      - "!.github/workflows/deploy-docker-tag.yml"
      - "!.github/workflows/deploy-image.yml"
      - "!.github/workflows/docker-slim.yml"
      - "!.github/workflows/lighthouse-badger.yml"
      - "!.github/workflows/prettier.yml"
      - "!lighthouse_results/**"
      - "!CONTRIBUTING.md"
      - "!CUSTOMIZE.md"
      - "!FAQ.md"
      - "!INSTALL.md"
      - "!README.md"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    # available images: https://github.com/actions/runner-images#available-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
      - name: Setup Ruby üíé
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.5"
          bundler-cache: true
      - name: Update _config.yml ‚öôÔ∏è
        uses: fjogeleit/yaml-update-action@main
        with:
          commitChange: false
          valueFile: "_config.yml"
          propertyPath: "giscus.repo"
          value: ${{ github.repository }}
      - name: Install and Build üîß
        run: |
          export JEKYLL_ENV=production
          bundle exec jekyll build
      - name: Deploy üöÄ
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: _site
          branch: gh-pages # Ensure it deploys to the branch you created
      - name: Notify Discord üì£
        continue-on-error: true
        if: github.event_name != 'pull_request' && env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          pip install pyyaml
          python3 << 'EOF'
          import yaml, datetime, json, urllib.request, os, glob

          plan_files = sorted(glob.glob("data/plans/*.yaml"))
          if not plan_files:
              print("No plan files found, skipping notification")
              raise SystemExit(0)

          with open(plan_files[-1]) as f:
              plan = yaml.safe_load(f)

          week_num = plan["week_number"]
          finalized = plan.get("finalized_at", "")
          if finalized:
              dt = datetime.datetime.fromisoformat(finalized.replace("Z", "+00:00"))
              date_str = dt.strftime("%Y-%m-%d")
          else:
              date_str = datetime.date.today().isoformat()

          days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
          lines = []
          for day in days:
              meals = plan["days"].get(day, {})
              lunch = meals.get("lunch", "-")
              dinner = meals.get("dinner", "-")
              lines.append(f"**{day.capitalize()}** ‚Äî {lunch} / {dinner}")

          schedule = "\n".join(lines)
          plan_url = f"https://mallydietrich.github.io/meal-planning/plans/{date_str}-week-{week_num}-plan/"
          message = f"üìã **Here's your weekly plan!**\n\n{schedule}\n\nüîó Full plan & grocery list: {plan_url}"

          payload = json.dumps({"content": message}).encode("utf-8")
          req = urllib.request.Request(
              os.environ["DISCORD_WEBHOOK_URL"],
              data=payload,
              headers={"Content-Type": "application/json"},
              method="POST",
          )
          urllib.request.urlopen(req)
          print(f"Discord notification sent for Week {week_num}")
          EOF
